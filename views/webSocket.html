{% extends 'layout.html' %}


{% block head %}
<title>{{title}}</title>

<script src="socket.io/socket.io.js"></script>
	<script>
	
		var socket;
		function btnConnect(){
			if(socket===undefined){
				socket=io('http://{{ ip }}:{{ port }}');
			}
		socket.on('connect',function(){
			console.log('client connect');
		});
		socket.on('connecting',function(){
			console.log('connecting');
		});
		socket.on('disconnect',function(){
			console.log('disconnect');
		});
		socket.on('connect_failed',function(){
			console.log('connect_failed');
		});

		socket.on('news',function(recv){
			console.log('from server : '+recv.msg);
			socket.emit('sendMyData',{msg:'msg received'});
		});
		socket.on('system',function(data){
			var sect_ul=document.querySelector('#showMsg ul');
			var ttime=new Date(data.time);
			var ddate=ttime.getHours()+':'+ttime.getMinutes()+':'+ttime.getSeconds();
			sect_ul.innerHTML+='<li>'+data.author+': '+data.type+' '+data.text+' '+ddate+'</li>';	


		});
		socket.on('message',function(data){
			var sect_ul=document.querySelector('#showMsg ul');
			var ttime=new Date(data.time);
			var ddate=ttime.getHours()+':'+ttime.getMinutes()+':'+ttime.getSeconds();
			sect_ul.innerHTML+='<li><label class="'+data.author+'">'+data.author+'</label>: '+data.text+' '+ddate+'</li>';	

		});
		socket.on('private message',function(data){
			var sect_ul=document.querySelector('#showMsg ul');
			var ttime=new Date(data.time);
			var ddate=ttime.getHours()+':'+ttime.getMinutes()+':'+ttime.getSeconds();
			sect_ul.innerHTML+='<li>'+data.author+'->'+data.to+': '+data.text+' '+ddate+'</li>';	


		});
	}
		function ws_send(){
			var txt=document.querySelector("#text").value;
			if($.trim(txt)===''){
				$('#text').tooltip('show');
				return;
			}
			//ws.send(txt);
			var cname=document.querySelector('#cname');
			if(cname.value!=''){
				socket.emit('private message',cname.value,txt);	
			}else{
				socket.send(txt);
			}
			//socket.emit('sendMyData',{msg:txt});
			document.querySelector("#text").value="";
		}
		var longPressTime;
		$(function(){
			resizeHeight(document.body.scrollHeight);
			$('#cname').on('mousedown',function(){
				console.log('cname down');
			});
			$(document).on('mousedown','#showMsg ul li label',function(){
				console.log('down');
				var name=$(this).html();
				longPressTime=setTimeout(function(){
					$('#cname').val(name);	
				},2000);
			});
			$(document).on('mouseup','#showMsg ul li label',function(){
				console.log('up');
				clearTimeout(longPressTime);
			});
		});
		window.onresize=function(){
			resizeHeight(window.innerHeight);
		};

		function resizeHeight(hhh){
			var h=hhh-$('#showMsg').offset().top-15;
			$('#showMsg').css('height',h+'px');
			var hpm=document.body.scrollHeight-$('#cname').parent().offset().top;
			h=$('#showMsg').height()-hpm-30;
			$('#showMsg').css('height',h+'px');
		}
	</script>
	<style>
		/*
		#showMsg ul li label{
			-webkit-touch-callout:none;
			-webkit-user-select:none;
			-khtml-user-select:none;
			-moz-user-select:none;
			-ms-user-select:none;
			user-select:none;
		}
		*/
	</style>

{%endblock%}



{% block title %}
{{title}}
{%endblock%}

{% block content %}
	<div class="form-group" style="height:100%;overflow-y:auto;">
		<button class="btn btn-primary pull-right" onclick="btnConnect();">connect</button>
	</div>
	<div class="form-group">
		<section id='showMsg' style="clear:both;display:block;margin-bottom:30px;height:100px;overflow-y:auto;border:1px solid gray;">
			<ul></ul>	
		</section>
	</div>
	<div class="form-group">
		<label class="lb_pm">private message:</label>
		<input class="form-control" type='text' id='cname' placeholder='input client name' />
	</div>
	
	<div class="form-group">
		<textarea id="text" class="form-control" data-placement="bottom" 
			   title="can't be empty" rows="3" cols="50"></textarea>
		<button class="btn btn-default pull-right" style="margin-top:15px;" onclick="ws_send();">send</button>
	</div>

{%endblock%}
